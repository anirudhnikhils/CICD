pipeline {
    agent any

    environment {
        REGISTRY_CREDENTIALS = credentials('docker-cred')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out the repository'
                cleanWs()
                checkout([$class: 'GitSCM',
                    branches: [[name: 'main']],
                    userRemoteConfigs: [[url: 'https://github.com/anirudhnikhils/CICD']]
                ])
            }
        }

        stage('Verify Dockerfile') {
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    echo 'Verifying Dockerfile exists'
                    sh 'ls -l Dockerfile'
                }
            }
        }

        stage('Build and Package') {
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    echo 'Building and Packaging the application'
                    sh 'docker build -t your-app-image1:latest -f Dockerfile .'
                }
            }
        }

        stage('Docker Login and Push') {
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    echo 'Logging in and pushing the Docker image'
                    withCredentials([usernamePassword(credentialsId: 'docker-cred', usernameVariable: 'REGISTRY_CREDENTIALS_USR', passwordVariable: 'REGISTRY_CREDENTIALS_PSW')]) {
                        sh '''
                            docker login -u $REGISTRY_CREDENTIALS_USR -p $REGISTRY_CREDENTIALS_PSW
                            docker push your-app-image1:latest
                        '''
                    }
                }
            }
        }
    }
}
